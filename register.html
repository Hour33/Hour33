<script>
  const SHEETY_URL = "https://api.sheety.co/4a9868f3c5ce48f976e575a769b00f1c/usersdb6/usersdb6";

  document.getElementById('registerBtn').addEventListener('click', async () => {
    const phone = document.getElementById('phone').value.trim();
    const password = document.getElementById('password').value.trim();
    const confirmPassword = document.getElementById('confirmPassword').value.trim();
    const msg = document.getElementById('msg');

    if (!phone || !password || !confirmPassword) {
      msg.style.color = "red";
      msg.textContent = "Please fill all fields";
      return;
    }

    if (password !== confirmPassword) {
      msg.style.color = "red";
      msg.textContent = "Passwords do not match";
      return;
    }

    msg.style.color = "#222";
    msg.textContent = "Checking account...";

    try {
      /* ===== SAFE DUPLICATE CHECK ===== */
      const checkRes = await fetch(SHEETY_URL);
      const checkData = await checkRes.json();

      const users = Array.isArray(checkData.usersdb6)
        ? checkData.usersdb6
        : [];

      const exists = users.some(
        u => String(u.phone) === phone
      );

      if (exists) {
        msg.style.color = "red";
        msg.textContent = "Account already exists";
        return;
      }
      /* ===== END CHECK ===== */

      msg.textContent = "Registering...";

      const res = await fetch(SHEETY_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          usersdb6: {
            phone: phone,
            password: password,
            balance: 200
          }
        })
      });

      const data = await res.json();

      if (!res.ok) {
        msg.style.color = "red";
        msg.textContent = "Error: " + JSON.stringify(data);
        return;
      }

      msg.style.color = "#4caf50";
      msg.textContent = "Registered successfully! Redirecting...";
      setTimeout(() => location.href = "login.html", 1000);

    } catch (err) {
      msg.style.color = "red";
      msg.textContent = "Network error: " + err.message;
    }
  });
</script>
